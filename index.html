<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Pesan Online - Warung Mie</title>
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);min-height:100vh;padding:20px}
    .container{max-width:1000px;margin:0 auto;padding:30px;background:#fff;border-radius:16px;box-shadow:0 20px 60px rgba(0,0,0,.3)}
    .closed-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.95);z-index:9999;display:none;align-items:center;justify-content:center}
    .closed-overlay.show{display:flex}
    .closed-message{text-align:center;color:#fff;padding:40px}
    .closed-message h1{font-size:48px;margin-bottom:20px}
    .closed-message p{font-size:20px;margin-bottom:10px}
    .clock{font-size:64px;font-weight:700;color:#fbbf24;margin:30px 0}
    .header{text-align:center;margin-bottom:30px;padding-bottom:20px;border-bottom:2px solid #f0f0f0}
    h1{font-size:32px;color:#333;margin-bottom:8px}
    .subtitle{color:#666;font-size:16px}
    .operating-hours{background:#fffbea;padding:12px;border-radius:8px;margin-top:10px;font-size:14px;color:#92400e;text-align:center}
    .section-title{font-size:20px;color:#333;margin:25px 0 15px;padding-bottom:8px;border-bottom:2px solid #667eea}
    .menu-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:16px;margin-top:20px}
    .card{border:2px solid #e0e7ff;padding:16px;border-radius:12px;transition:all .3s;background:#fafbff}
    .card:hover{border-color:#667eea;transform:translateY(-2px);box-shadow:0 4px 12px rgba(102,126,234,.2)}
    .card-title{font-weight:600;font-size:15px;color:#333;margin-bottom:4px}
    .card-price{color:#667eea;font-size:14px;font-weight:600;margin-bottom:12px}
    .qty-control{display:flex;align-items:center;gap:8px}
    .qty-control label{font-size:13px;color:#666}
    .qty-control input{width:70px;padding:8px;border-radius:8px;border:2px solid #e0e7ff;text-align:center;font-size:14px}
    .qty-control input:focus{outline:none;border-color:#667eea}
    .summary{margin-top:30px;padding:20px;border-radius:12px;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:#fff}
    .summary h3{font-size:18px;margin-bottom:12px}
    .summary-content{background:rgba(255,255,255,.15);padding:15px;border-radius:8px;backdrop-filter:blur(10px)}
    .order-item{padding:8px 0;border-bottom:1px solid rgba(255,255,255,.2);font-size:14px}
    .order-item:last-child{border:0}
    .total-row{font-size:20px;font-weight:700;margin-top:12px;padding-top:12px;border-top:2px solid rgba(255,255,255,.3)}
    .form-section{margin-top:30px}
    .form-group{margin-bottom:20px}
    .form-label{display:block;font-size:14px;color:#333;font-weight:600;margin-bottom:8px}
    .form-label .required{color:#ef4444;font-weight:700}
    .form-input{width:100%;padding:12px;border-radius:8px;border:2px solid #e0e7ff;font-size:14px;transition:border .3s}
    .form-input:focus{outline:none;border-color:#667eea}
    .form-input.error{border-color:#ef4444;background:#fee}
    .file-preview{margin-top:10px;padding:10px;background:#f0f9ff;border-radius:8px;font-size:13px;color:#0c4a6e;display:none}
    .file-preview.show{display:block}
    .btn{display:inline-block;padding:14px 32px;border-radius:10px;border:0;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:#fff;cursor:pointer;font-size:16px;font-weight:600;transition:all .3s;width:100%;margin-top:10px}
    .btn:hover:not(:disabled){transform:translateY(-2px);box-shadow:0 8px 20px rgba(102,126,234,.4)}
    .btn:disabled{opacity:.6;cursor:not-allowed;transform:none}
    .btn-clear{background:linear-gradient(135deg,#ef4444 0%,#dc2626 100%);margin-top:5px}
    .note{background:#fff9e6;padding:16px;border-radius:10px;border-left:4px solid #fbbf24;margin-top:20px;font-size:14px;color:#92400e}
    .note-title{font-weight:700;margin-bottom:8px;color:#78350f}
    .warning-box{background:#fee2e2;padding:16px;border-radius:10px;border-left:4px solid #ef4444;margin-top:15px;font-size:14px;color:#991b1b}
    .modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.7);z-index:1000;align-items:center;justify-content:center}
    .modal.show{display:flex}
    .modal-content{background:#fff;padding:30px;border-radius:16px;max-width:500px;text-align:center;animation:slideDown .3s}
    @keyframes slideDown{from{transform:translateY(-50px);opacity:0}to{transform:translateY(0);opacity:1}}
    .modal-icon{font-size:64px;margin-bottom:20px;animation:scaleUp .5s}
    @keyframes scaleUp{from{transform:scale(0)}to{transform:scale(1)}}
    .modal-title{font-size:24px;font-weight:700;margin-bottom:10px;color:#333}
    .modal-message{font-size:16px;color:#666;margin-bottom:20px;line-height:1.6}
    .modal-details{background:#f3f4f6;padding:15px;border-radius:8px;margin-bottom:20px;text-align:left}
    .modal-details div{margin:8px 0;font-size:14px}
    .progress-bar{width:100%;height:4px;background:#e5e7eb;border-radius:2px;overflow:hidden;margin-top:20px}
    .progress-fill{height:100%;background:linear-gradient(90deg,#667eea,#764ba2);animation:fillProgress 3s linear}
    @keyframes fillProgress{from{width:0}to{width:100%}}
    .auto-close-text{font-size:12px;color:#999;margin-top:10px}
    .empty-order{color:rgba(255,255,255,.8);font-style:italic;font-size:14px}
    .help-text{font-size:12px;color:#666;margin-top:5px}
    .saved-indicator{display:inline-block;color:#10b981;font-size:12px;margin-left:10px;animation:fadeIn .3s}
    @keyframes fadeIn{from{opacity:0}to{opacity:1}}
    @media(max-width:640px){.container{padding:20px}h1{font-size:24px}.menu-grid{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <!-- Closed Hours Overlay -->
  <div id="closedOverlay" class="closed-overlay">
    <div class="closed-message">
      <h1>üåô TUTUP</h1>
      <p>Maaf, kami sedang tutup</p>
      <div class="clock" id="currentClock">--:--</div>
      <p><strong>Jam Operasional:</strong></p>
      <p>06:00 - 18:00 WIB</p>
      <p style="margin-top:20px;font-size:16px">Silakan kembali saat jam operasional</p>
    </div>
  </div>

  <!-- Success Modal (Auto-Close) -->
  <div id="successModal" class="modal">
    <div class="modal-content">
      <div class="modal-icon">‚úÖ</div>
      <div class="modal-title">Pesanan Berhasil Dikirim!</div>
      <div class="modal-message">
        Terima kasih telah memesan di Warung Mie.<br>
        Pesanan Anda telah tersimpan dengan aman.
      </div>
      <div class="modal-details" id="modalDetails"></div>
      <div class="progress-bar">
        <div class="progress-fill"></div>
      </div>
      <div class="auto-close-text">Halaman akan direset otomatis dalam 3 detik...</div>
    </div>
  </div>

  <div class="container">
    <div class="header">
      <h1>üçú Warung Mie - Pesan Online</h1>
      <p class="subtitle">Pilih menu favorit Anda dan pesan sekarang!</p>
      <div class="operating-hours">
        ‚è∞ Jam Operasional: 06:00 - 18:00 WIB
      </div>
    </div>

    <h2 class="section-title">üìã Menu Tersedia</h2>
    <div class="menu-grid" id="menuGrid"></div>

    <div class="summary">
      <h3>üõí Ringkasan Pesanan Anda</h3>
      <div class="summary-content">
        <div id="orderList" class="empty-order">Belum ada item dipilih</div>
        <div class="total-row">
          Total: <span id="grandTotal">Rp 0</span>
        </div>
      </div>
    </div>

    <form id="orderForm" class="form-section">
      <h2 class="section-title">üë§ Informasi Pemesan</h2>
      
      <div class="form-group">
        <label class="form-label">
          Nama Lengkap <span class="required">*</span>
          <span id="namaSaved" class="saved-indicator" style="display:none">‚úì Tersimpan</span>
        </label>
        <input type="text" name="nama" id="nama" class="form-input" placeholder="Masukkan nama lengkap Anda" required />
        <div class="help-text">Data tersimpan otomatis hingga pesanan terkirim</div>
      </div>

      <div class="form-group">
        <label class="form-label">
          Nomor WhatsApp <span class="required">*</span>
          <span id="waSaved" class="saved-indicator" style="display:none">‚úì Tersimpan</span>
        </label>
        <input type="tel" name="whatsapp" id="wa" class="form-input" placeholder="08xxxxxxxxxx" required pattern="08[0-9]{8,11}" />
        <div class="help-text">Format: 08xxxxxxxxxx (dimulai dengan 08)</div>
      </div>

      <div class="form-group">
        <label class="form-label">
          üì∏ Upload Bukti Pembayaran <span class="required">*</span>
          <span id="fileSaved" class="saved-indicator" style="display:none">‚úì Tersimpan</span>
        </label>
        <input type="file" name="bukti" id="bukti" class="form-input" accept="image/jpeg,image/jpg,image/png,application/pdf" required />
        <div class="help-text">Format: JPG, PNG, atau PDF (Max 5MB) - WAJIB</div>
        <div id="filePreview" class="file-preview"></div>
      </div>

      <div class="warning-box">
        <strong>‚ö†Ô∏è INFO PENTING:</strong>
        <ul style="margin-top:8px;margin-left:20px">
          <li>Semua data tersimpan otomatis hingga pesanan berhasil dikirim</li>
          <li>Refresh halaman tidak akan menghilangkan data Anda</li>
          <li>Setelah pesanan terkirim, halaman akan otomatis direset</li>
        </ul>
      </div>

      <input type="hidden" id="webAppUrl" value="https://script.google.com/macros/s/AKfycbyz4fnqITdbXML9NxSg3OYAHAfxD6ru-MUZ4-KK81JEFaE3dAvsTwzn365Nbsw3gJ_ZHw/exec" />

      <button type="button" class="btn" id="submitBtn">
        <span id="btnText">üöÄ Kirim Pesanan</span>
      </button>
      
      <button type="button" class="btn btn-clear" id="clearBtn">
        üóëÔ∏è Hapus Semua Data (Manual)
      </button>
    </form>

    <div class="note">
      <div class="note-title">üí≥ Informasi Pembayaran</div>
      <p><strong>Transfer ke rekening:</strong><br>
      BCA: <strong>1234567890</strong><br>
      a.n. <strong>Warung Mie</strong></p>
      <p style="margin-top:10px">Setelah transfer, <strong>WAJIB</strong> upload bukti pembayaran.</p>
    </div>
  </div>

  <script>
    const MENU = [
      {id:'Mie Hompimpa Lv1', price:15000}, {id:'Mie Hompimpa Lv3', price:15000},
      {id:'Mie Gacoan Lv0', price:15000}, {id:'Mie Gacoan Lv1', price:15000},
      {id:'Mie Gacoan Lv2', price:15000}, {id:'Mie Gacoan Lv3', price:15000},
      {id:'Mie Gacoan Lv4', price:15000}, {id:'Mie Gacoan Lv6', price:15000},
      {id:'Udang Keju', price:12000}, {id:'Udang Rambutan', price:12000},
      {id:'Pangsit Goreng', price:14000}, {id:'Siomay', price:13000},
      {id:'Lumpia Udang', price:13000}, {id:'Lemon Tea', price:8000},
      {id:'Tea', price:6000}, {id:'Es Gobak Sodor', price:16000}
    ];

    const state = {};
    let savedFile = null;

    // ============ OPERATING HOURS CHECK ============
    function checkOperatingHours() {
      const now = new Date();
      const hours = now.getHours();
      const isOpen = hours >= 6 && hours < 18;
      
      document.getElementById('closedOverlay').classList.toggle('show', !isOpen);
      
      if (!isOpen) {
        const timeStr = now.toLocaleTimeString('id-ID', {hour: '2-digit', minute: '2-digit', second: '2-digit'});
        document.getElementById('currentClock').textContent = timeStr;
      }
      
      return isOpen;
    }

    setInterval(() => {
      if (!checkOperatingHours()) {
        const now = new Date();
        const timeStr = now.toLocaleTimeString('id-ID', {hour: '2-digit', minute: '2-digit', second: '2-digit'});
        document.getElementById('currentClock').textContent = timeStr;
      }
    }, 1000);

    if (!checkOperatingHours()) {
      document.body.style.overflow = 'hidden';
    }

    // ============ LOCAL STORAGE FUNCTIONS ============
    function saveToStorage() {
      try {
        localStorage.setItem('warungmie_order', JSON.stringify(state));
        localStorage.setItem('warungmie_nama', document.getElementById('nama').value);
        localStorage.setItem('warungmie_wa', document.getElementById('wa').value);
        
        // Show saved indicators
        if (document.getElementById('nama').value) {
          document.getElementById('namaSaved').style.display = 'inline-block';
          setTimeout(() => document.getElementById('namaSaved').style.display = 'none', 2000);
        }
        if (document.getElementById('wa').value) {
          document.getElementById('waSaved').style.display = 'inline-block';
          setTimeout(() => document.getElementById('waSaved').style.display = 'none', 2000);
        }
      } catch (e) {
        console.warn('LocalStorage not available');
      }
    }

    function loadFromStorage() {
      try {
        const savedOrder = localStorage.getItem('warungmie_order');
        const savedNama = localStorage.getItem('warungmie_nama');
        const savedWa = localStorage.getItem('warungmie_wa');
        
        if (savedOrder) {
          Object.assign(state, JSON.parse(savedOrder));
          Object.entries(state).forEach(([id, qty]) => {
            const input = document.querySelector(`input[data-id="${id}"]`);
            if (input) input.value = qty;
          });
          renderOrder();
        }
        
        if (savedNama) document.getElementById('nama').value = savedNama;
        if (savedWa) document.getElementById('wa').value = savedWa;
      } catch (e) {
        console.warn('Failed to load from storage');
      }
    }

    function clearStorage() {
      try {
        localStorage.removeItem('warungmie_order');
        localStorage.removeItem('warungmie_nama');
        localStorage.removeItem('warungmie_wa');
      } catch (e) {}
    }

    // ============ UI FUNCTIONS ============
    function currency(num){ 
      return new Intl.NumberFormat('id-ID', {
        style: 'currency', currency: 'IDR', minimumFractionDigits: 0
      }).format(num);
    }

    function renderMenu(){
      const menuGrid = document.getElementById('menuGrid');
      menuGrid.innerHTML = '';
      
      MENU.forEach(item=>{
        const card = document.createElement('div');
        card.className='card';
        card.innerHTML = `
          <div class="card-title">${item.id}</div>
          <div class="card-price">${currency(item.price)}</div>
          <div class="qty-control">
            <label>Jumlah:</label>
            <input type="number" min="0" max="99" value="0" data-id="${item.id}" />
          </div>
        `;
        menuGrid.appendChild(card);
      });
      
      menuGrid.querySelectorAll('input[type=number]').forEach(inp=>{
        inp.addEventListener('input', onQtyChange);
      });
    }

    function onQtyChange(e){
      const id = e.target.dataset.id;
      const qty = parseInt(e.target.value) || 0;
      if(qty>0) state[id]=qty; else delete state[id];
      renderOrder();
      saveToStorage();
    }

    function renderOrder(){
      const orderList = document.getElementById('orderList');
      const grandTotalEl = document.getElementById('grandTotal');
      const entries = Object.entries(state);
      
      if(entries.length===0){
        orderList.innerHTML = '<div class="empty-order">Belum ada item dipilih</div>';
        grandTotalEl.textContent = 'Rp 0';
        return;
      }
      
      let html = '';
      let grand = 0;
      
      entries.forEach(([id, qty])=>{
        const menuItem = MENU.find(m=>m.id===id);
        const total = menuItem.price * qty;
        grand += total;
        html += `<div class="order-item">${id} √ó ${qty} = ${currency(total)}</div>`;
      });
      
      orderList.innerHTML = html;
      grandTotalEl.textContent = currency(grand);
    }

    // ============ FILE HANDLING ============
    document.getElementById('bukti').addEventListener('change', function(e){
      const file = e.target.files[0];
      const preview = document.getElementById('filePreview');
      
      if(file){
        savedFile = file;
        const size = (file.size / 1024 / 1024).toFixed(2);
        preview.innerHTML = `‚úì File dipilih: <strong>${file.name}</strong> (${size} MB)`;
        preview.classList.add('show');
        e.target.classList.remove('error');
        
        document.getElementById('fileSaved').style.display = 'inline-block';
        setTimeout(() => document.getElementById('fileSaved').style.display = 'none', 2000);
      } else {
        savedFile = null;
        preview.classList.remove('show');
      }
    });

    function fileToBase64(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result.split(',')[1]);
        reader.onerror = reject;
        reader.readAsDataURL(file);
      });
    }

    // ============ SUCCESS MODAL WITH AUTO-CLOSE ============
    function showSuccessModal(data) {
      const details = `
        <div><strong>üì¶ Item:</strong> ${data.orderCount} item</div>
        <div><strong>üí∞ Total:</strong> ${currency(data.totalAmount)}</div>
        <div><strong>‚úÖ Google Sheet:</strong> Tersimpan</div>
        <div><strong>üì∏ Bukti Bayar:</strong> Tersimpan di Drive</div>
      `;
      document.getElementById('modalDetails').innerHTML = details;
      document.getElementById('successModal').classList.add('show');
      
      // AUTO-CLOSE & AUTO-CLEAR AFTER 3 SECONDS
      setTimeout(() => {
        closeSuccessModalAndClear();
      }, 3000);
    }

    function closeSuccessModalAndClear() {
      // Close modal
      document.getElementById('successModal').classList.remove('show');
      
      // Clear all data immediately
      clearStorage();
      document.getElementById('orderForm').reset();
      document.getElementById('filePreview').classList.remove('show');
      Object.keys(state).forEach(k=>delete state[k]);
      document.querySelectorAll('#menuGrid input[type=number]').forEach(i=>i.value=0);
      savedFile = null;
      renderOrder();
      
      // Scroll to top
      window.scrollTo({top: 0, behavior: 'smooth'});
    }

    // ============ FORM SUBMISSION ============
    async function submitOrder(){
      if (!checkOperatingHours()) {
        alert('‚ùå Maaf, kami sedang tutup. Silakan pesan saat jam operasional (06:00 - 18:00 WIB)');
        return;
      }

      const nama = document.getElementById('nama').value.trim();
      const wa = document.getElementById('wa').value.trim();
      const webAppUrl = document.getElementById('webAppUrl').value;
      const submitBtn = document.getElementById('submitBtn');
      const btnText = document.getElementById('btnText');

      document.querySelectorAll('.form-input').forEach(el => el.classList.remove('error'));

      if(!nama){ 
        document.getElementById('nama').classList.add('error');
        alert('‚ùå Nama wajib diisi!');
        return; 
      }

      if(!wa || !/^08\d{8,11}$/.test(wa)){ 
        document.getElementById('wa').classList.add('error');
        alert('‚ùå Nomor WhatsApp tidak valid!');
        return;
      }

      const order = Object.entries(state).map(([id,qty])=>({id,qty}));
      if(order.length===0){ 
        alert('‚ùå Pilih menu terlebih dahulu!');
        return; 
      }

      if(!savedFile){
        document.getElementById('bukti').classList.add('error');
        alert('‚ùå Bukti pembayaran WAJIB diupload!');
        return;
      }

      if(savedFile.size > 5 * 1024 * 1024){
        alert('‚ùå File terlalu besar (max 5MB)!');
        return;
      }

      if(!webAppUrl || webAppUrl.includes('PASTE')){
        alert('‚ùå Web App belum dikonfigurasi!');
        return;
      }

      submitBtn.disabled = true;
      btnText.textContent = '‚è≥ Mengupload...';
      
      try{
        const fd = new FormData();
        fd.append('nama', nama);
        fd.append('whatsapp', wa);
        fd.append('order', JSON.stringify(order));

        const base64Data = await fileToBase64(savedFile);
        fd.append('bukti', base64Data);
        fd.append('buktiName', savedFile.name);
        fd.append('buktiType', savedFile.type);

        btnText.textContent = 'üíæ Menyimpan...';
        const res = await fetch(webAppUrl, {method: 'POST', body: fd});
        const data = await res.json();
        
        if(data.status === 'ok'){
          // Show success modal (will auto-close and auto-clear after 3 seconds)
          showSuccessModal(data);
        } else {
          alert('‚ùå ' + (data.message || 'Gagal mengirim'));
        }
      } catch(err){
        console.error(err);
        alert('‚ùå Error: ' + err.message);
      } finally { 
        submitBtn.disabled = false;
        btnText.textContent = 'üöÄ Kirim Pesanan';
      }
    }

    function clearAllData(){
      if(confirm('Hapus semua data pesanan?\n\nData yang tersimpan sementara akan dihapus.')){
        clearStorage();
        document.getElementById('orderForm').reset();
        document.getElementById('filePreview').classList.remove('show');
        Object.keys(state).forEach(k=>delete state[k]);
        document.querySelectorAll('#menuGrid input[type=number]').forEach(i=>i.value=0);
        savedFile = null;
        renderOrder();
        alert('‚úì Semua data telah dihapus');
      }
    }

    // ============ AUTO-SAVE ============
    document.getElementById('nama').addEventListener('input', saveToStorage);
    document.getElementById('wa').addEventListener('input', saveToStorage);

    // ============ EVENT LISTENERS ============
    document.getElementById('submitBtn').addEventListener('click', submitOrder);
    document.getElementById('clearBtn').addEventListener('click', clearAllData);
    document.getElementById('orderForm').addEventListener('submit', e => e.preventDefault());

    // ============ INITIALIZATION ============
    renderMenu();
    loadFromStorage();
    renderOrder();
  </script>
</body>
</html>
